<style>

header, footer {
  text-align: center;
  margin: 1px 0;
}

header h1 {
  color: #00bfa5;
  margin-bottom: 5px;
}

header p {
  color: #ccc;
  font-size: 1em;
}

.pinfo {
  color: #4B50E5;
  font-size: 1.2em;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
}

.pinfo2 {
  color: red;
  font-size: 0.9em;
  display: flex;
  flex-wrap: wrap;
  justify-content: left;
}

.swap-container {
  display: flex;
  gap: 40px;
  flex-wrap: wrap;
  justify-content: center;
}

.swap-column {
  flex: 1;
  min-width: 300px;
  background-color: #1e1e1e;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
  transition: transform 0.2s ease;
}

.swap-column:hover {
  transform: translateY(-4px);
}

h2 {
  margin-top: 0;
  color: #00bfa5;
}

h3 {
  margin-top: 20px;
  color: #80cbc4;
}

.form-group {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

input, button {
  width: 100%;
  box-sizing: border-box;
  margin: 6px 0;
  padding: 10px;
  border-radius: 6px;
  border: none;
  font-size: 1em;
}

input {
  background-color: #2a2a2a;
  color: #fff;
}

button {
  background-color: #00bfa5;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.1s ease;
}

button:hover {
  background-color: #009e88;
}

button:active {
  transform: scale(0.98);
}

pre {
  background-color: #2a2a2a;
  padding: 10px;
  border-radius: 6px;
  overflow-x: auto;
  white-space: pre-wrap;
  color: #e0e0e0;
}

footer {
  color: #666;
  font-size: 0.9em;
}

@media (max-width: 768px) {
  .swap-container {
    flex-direction: column;
    gap: 20px;
  }
}
  </style>

  <header>
    <h1>âš¡ Mytherra Swap</h1>
    <p>Fast, secure, and easy crypto swaps</p>
  </header>

  <main class="swap-container">
    <!-- Column 1: BTC â†’ Mytherra -->
    <section class="swap-column">
      <h2>ğŸ” Swap Bitcoin â†’ Mytherra</h2>

      <h3>ğŸ“Š Pool Data</h3>
      <div class="form-group">
        <button onclick="checkPool('bitcoin', 'btcToAltPool')">Check Pool</button>
        <pre id="btcToAltPool"></pre>
      </div>

      <h3>ğŸ§® Calculate Payout</h3>
      <div class="form-group">
	  	<div class="pinfo">
			<p>Swap fee: ~ 0.5 to 1%</p>
		</div>
        <input type="number" id="btcAmount" placeholder="ğŸ’° Amount in BTC" step="0.0001">
        <button onclick="calculatePayout('bitcoin', 'mytherra', 'btcAmount', 'btcToAltPayout')">Calculate</button>
        <pre id="btcToAltPayout"></pre>
      </div>
	  	<div class="pinfo2">
			<p>***Disclaimer: The estimated price shown is not guaranteed.<br>
			   Actual execution may differ due to slippage, which can occur when liquidity is limited or trading volume is high.</p>
		</div>

      <h3>ğŸš€ Start Swap</h3>
      <div class="form-group">
        <input type="text" id="btcAddress" placeholder="ğŸ¦ Your Mytherra address">
        <button onclick="startSwap('bitcoin', 'mytherra', 'btcAmount', 'btcAddress', 'btcToAltSwap')">Start Swap</button>
        <pre id="btcToAltSwap"></pre>
      </div>

      <h2>ğŸ” Check Swap Status</h2>
      <div class="form-group">
        <input type="text" id="swapIdInputLeft" placeholder="ğŸ” Enter Swap ID">
        <button onclick="checkSwapStatus('swapIdInputLeft', 'swapStatusOutputleft')">Check Status</button>
        <pre id="swapStatusOutputleft"></pre>
      </div>
    </section>

    <!-- Column 2: Mytherra â†’ BTC -->
    <section class="swap-column">
      <h2>ğŸ” Swap Mytherra â†’ Bitcoin</h2>

      <h3>ğŸ“Š Pool Data</h3>
      <div class="form-group">
        <button onclick="checkPool('mytherra', 'altToBtcPool')">Check Pool</button>
        <pre id="altToBtcPool"></pre>
      </div>

      <h3>ğŸ§® Calculate Payout</h3>
      <div class="form-group">
	  	<div class="pinfo">
			<p>Swap fee: ~ 0.5 to 1%</p>
		</div>
        <input type="number" id="altAmount" placeholder="ğŸ’° Amount in Mytherra" step="0.0001">
        <button onclick="calculatePayout('mytherra', 'bitcoin', 'altAmount', 'altToBtcPayout')">Calculate</button>
        <pre id="altToBtcPayout"></pre>
      </div>
	  	<div class="pinfo2">
			<p>***Disclaimer: The estimated price shown is not guaranteed.<br>
			   Actual execution may differ due to slippage, which can occur when liquidity is limited or trading volume is high.</p>
		</div>

      <h3>ğŸš€ Start Swap</h3>
      <div class="form-group">
        <input type="text" id="altAddress" placeholder="ğŸ¦ Your Bitcoin address">
        <button onclick="startSwap('mytherra', 'bitcoin', 'altAmount', 'altAddress', 'altToBtcSwap')">Start Swap</button>
        <pre id="altToBtcSwap"></pre>
      </div>

      <h2>ğŸ” Check Swap Status</h2>
      <div class="form-group">
        <input type="text" id="swapIdInputRight" placeholder="ğŸ” Enter Swap ID">
        <button onclick="checkSwapStatus('swapIdInputRight', 'swapStatusOutputright')">Check Status</button>
        <pre id="swapStatusOutputright"></pre>
      </div>
    </section>
  </main>

  <footer>
    <p>Â© 2025 Mytherra. All rights reserved.</p>
  </footer>
  
  <script>
  
async function checkPool(coin, outputId) {
  const button = event?.target;
  if (button) {
    button.disabled = true;
    button.textContent = "Checking...";
  }
  
  document.getElementById(outputId).textContent = "";

  try {
    const res = await fetch(`/2swap_info?coin=mytherra`);
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);

    const data = await res.json();

    const output = `

        ğŸŒŠ**Liquidity Pool Overview**

ğŸ’ BTC Pool Liquidity: ${Number(data.btc_pool).toLocaleString(undefined, { maximumFractionDigits: 8 })} BTC  
ğŸ¦ BTC Pool Address: ${data.btc_pool_address}  
ğŸ’µ BTC Price (USD): $${Number(data.btc_price_usd).toLocaleString()} 
ğŸŒ€ MYTH Pool Liquidity: ${Number(data.alt_pool).toFixed(8)} MYT 
ğŸ›ï¸ MYTH Pool Address: ${data.alt_pool_address}  
ğŸ’¸ MYTH Price (USD): $${Number(data.alt_price_usd).toFixed(8)}  
ğŸ§¿ MYTH Price (BTC): ${Number(data.alt_price_btc).toFixed(12)}  
â° Timestamp: ${new Date(data.timestamp * 1000).toLocaleString()}
`;

    document.getElementById(outputId).textContent = output;
  } catch (error) {
    document.getElementById(outputId).textContent =
      `âš ï¸ Error fetching pool data: ${error.message}`;
    console.error("Pool check failed:", error);
  } finally {
    if (button) {
      button.disabled = false;
      button.textContent = "Check Pool";
    }
  }
}
/*
async function checkPrice(from, to, outputId) {
  const testAmount = 1;
  const button = event.target; // Get the button that triggered the function

  // Disable the button and show loading text
  button.disabled = true;
  button.textContent = "Checking...";

  try {
    const res = await fetch("/2swap/?action=data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from, to, amount: testAmount })
    });

    const data = await res.json();
    const cashout = data?.cashout;
    const minAmount = data?.minAmount || "Unknown";

    let rate = "Unavailable";
    if (cashout) {
      rate = (cashout / testAmount).toLocaleString(undefined, { maximumFractionDigits: 8 });
    }

    document.getElementById(outputId).textContent =
      `ğŸ’± 1 ${from} â‰ˆ ${rate} ${to} `;
  } catch (error) {
    document.getElementById(outputId).textContent = "âš ï¸ Error fetching price.";
    console.error("Price check failed:", error);
  } finally {
    // Re-enable the button and reset its text
    button.disabled = false;
    button.textContent = "Check Price";
  }
}
*/

async function calculatePayout(from, to, amountId, outputId) {
  const amount = parseFloat(document.getElementById(amountId).value);
  const button = event.target;

  // Basic input validation
  if (isNaN(amount) || amount <= 0) {
    document.getElementById(outputId).textContent = "âš ï¸ Please enter a valid amount.";
    return;
  }

  // Disable the button and show loading text
  button.disabled = true;
  button.textContent = "Calculating...";
  document.getElementById(outputId).textContent = "";

  try {
    const res = await fetch("/2swap_query/?action=data", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ from, to, amount })
    });

    if (!res.ok) throw new Error(`HTTP error ${res.status}`);

    const data = await res.json();

    if (data.status === "error" && data.msg) {
      document.getElementById(outputId).textContent =
        `âš ï¸ Error calculating payout: ${data.msg}`;
      return;
    }

    const estimated = data?.cashout || "Unavailable";
    document.getElementById(outputId).textContent =
      `ğŸ§® Estimated Payout: ${estimated} ${to}`;
  } catch (error) {
    document.getElementById(outputId).textContent =
      `âš ï¸ Error calculating payout: ${error.message}`;
  } finally {
    button.disabled = false;
    button.textContent = "Calculate Payout";
  }
}

		async function startSwap(from, to, amountId, addressId, outputId) {
		  const button = event?.target;
		  if (button) {
			button.disabled = true;
			button.textContent = "Swaping...";
		  }
		  document.getElementById(outputId).textContent = "";

		  try {
			const rawAmount = document.getElementById(amountId).value;
			const address = document.getElementById(addressId).value;

			let amount;
			try {
			  amount = parseFloat(rawAmount);
			} catch (e) {
			  document.getElementById(outputId).textContent = "âš ï¸ Could not parse amount";
			  return;
			}

			if (!amount || isNaN(amount) || amount <= 0) {
			  document.getElementById(outputId).textContent = "âš ï¸ Invalid amount";
			  return;
			}

			if (!address || address.length < 10) {
			  document.getElementById(outputId).textContent = "âš ï¸ Invalid address";
			  return;
			}

			const res = await fetch("/2swap_swap/?action=swap", {
			  method: "POST",
			  headers: { "Content-Type": "application/json" },
			  body: JSON.stringify({ from, to, amount, address })
			});

			if (!res.ok) throw new Error(`HTTP error ${res.status}`);

			const result = await res.json();

			if (result.status === "ok" && result.swap) {
			  const swap = result.swap;
			  document.getElementById(outputId).textContent = `
        ğŸš€ Swap Started
		
ğŸ“¦ Deposit Amount: ${swap.deposit_amount}
ğŸ“¬ Deposit Address: ${swap.deposit_address}
ğŸ†” Swap ID: ${swap.swap_id}
ğŸ’¸ Estimated Fee: ${swap.est_fee ?? "Not available"}
			  `;
} else if (result.status === "error") {
  let reason = result.msg ?? "Unknown error";

  // Custom handling for pool balance error
  if (reason.includes("Pool balance too low")) {
    const match = reason.match(/Pool: ([\d.]+), Pending: ([\d.]+), Cashout: ([\d.]+)/);
    if (match) {
      const [, pool, pending, cashout] = match;
      reason = `Pool balance too low ğŸ’°
Available: ${pool}
Pending Swaps: ${pending}
Requested Cashout: ${cashout}

Try a smaller amount or wait for liquidity to refresh.`;
    }
  }

  document.getElementById(outputId).textContent = `
âŒ Swap Failed
ğŸ—¨ï¸ Reason: ${reason}
  `;
}
		  } catch (error) {
			document.getElementById(outputId).textContent =
			  `âš ï¸ Error starting swap: ${error.message}`;
			console.error("Swap initiation failed:", error);
		  } finally {
			if (button) {
			  button.disabled = false;
			  button.textContent = "Start Swap";
			}
		  }
		}

async function checkSwapStatus(inputId, outputId) {
  const button = event?.target;
  const input = document.getElementById(inputId);
  const output = document.getElementById(outputId);

  const id = input.value.trim();
  if (!id) {
    output.textContent = "âš ï¸ Please enter a Swap ID.";
    return;
  }

  if (button) {
    button.disabled = true;
    button.textContent = "Checking...";
  }

  output.textContent = "";

  try {
    const res = await fetch(`/2swap_check_id?id=${encodeURIComponent(id)}`);
    if (!res.ok) throw new Error(`HTTP error ${res.status}`);

    const result = await res.json();

    if (result.status === "error") {
      throw new Error(result.msg || "Swap not found");
    }

    if (!result.data) {
      throw new Error("No swap data returned");
    }

    const data = result.data;

    const swapOutput = `
        ğŸ” Swap Details:
		
ğŸ†” ID: ${data.id}
ğŸ’± From: ${data.from_coin.toUpperCase()}
â¡ï¸ To: ${data.to_coin.toUpperCase()}
ğŸ“¦ Amount: ${Number(data.amount).toFixed(8)}
ğŸ“¤ Send To: ${data.payment_address}
ğŸ“¥ Receiving Address: ${data.to_address}
ğŸ“Š Status: ${data.status === "completed" ? "âœ… Completed" : "â³ Pending"}
ğŸ•’ Created: ${new Date(data.created_at).toLocaleString()}
ğŸ•’ Updated: ${new Date(data.updated_at).toLocaleString()}
    `;

    output.textContent = swapOutput;
  } catch (error) {
    output.textContent = `âš ï¸ Error fetching swap status: ${error.message}`;
    console.error("Swap status check failed:", error);
  } finally {
    if (button) {
      button.disabled = false;
      button.textContent = "Check Status";
    }
  }
}	
  </script>